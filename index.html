<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Marriage Yoga Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #4a148c;
            --primary-light: #7c43bd;
            --primary-dark: #12005e;
            --accent: #ff9800;
            --accent-light: #ffc947;
            --accent-dark: #c66900;
            --success: #2e7d32;
            --success-light: #4caf50;
            --danger: #c62828;
            --danger-light: #ef5350;
            --bg-gradient-start: #faf8f5;
            --bg-gradient-end: #f5f0e8;
            --card-bg: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a6e;
            --text-muted: #8a8a9a;
            --border-color: #e8e0d5;
            --shadow-sm: 0 2px 8px rgba(74, 20, 140, 0.08);
            --shadow-md: 0 4px 20px rgba(74, 20, 140, 0.12);
            --shadow-lg: 0 8px 32px rgba(74, 20, 140, 0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== BASE STYLES ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
        }

        /* ===== HEADER ===== */
        .app-header {
            text-align: center;
            padding: 24px 16px 16px;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .logo-container {
            position: relative;
            z-index: 1;
        }

        .logo-container img {
            display: block;
            margin: 0 auto 12px;
            max-width: 100px;
            height: auto;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
        }

        .logo-link {
            display: inline-block;
            text-decoration: none;
        }

        .app-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: 0.5px;
        }

        .app-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 6px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* ===== CONTROLS SECTION ===== */
        .controls-section {
            background: var(--card-bg);
            margin: -20px 16px 20px;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 2;
        }

        .controls-grid {
            display: grid;
            gap: 16px;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 auto;
        }

        .control-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .form-control {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: var(--transition);
            background: #fff;
            min-width: 120px;
            flex: 1;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(124, 67, 189, 0.15);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 20, 140, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            box-shadow: 0 4px 12px rgba(74, 20, 140, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            min-width: 32px;
            border-radius: 50%;
            font-size: 1rem;
        }

        /* ===== INFO ICON ===== */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }

        .info-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
        }

        /* ===== MESSAGE ===== */
        .message {
            font-size: 0.8125rem;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
        }

        .message-success {
            background: rgba(46, 125, 50, 0.1);
            color: var(--success);
            border-left: 3px solid var(--success);
        }

        .message-error {
            background: rgba(198, 40, 40, 0.1);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .message-info {
            background: rgba(74, 20, 140, 0.08);
            color: var(--primary);
            border-left: 3px solid var(--primary-light);
        }

        /* ===== MAIN CONTENT ===== */
        .main-container {
            display: grid;
            grid-template-columns: minmax(280px, 380px) 1fr;
            gap: 24px;
            padding: 0 16px 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===== CHART SECTION ===== */
        .chart-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        /* ===== RASHI CHART ===== */
        .rashi-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            aspect-ratio: 1 / 1;
            gap: 0;
            background: var(--card-bg);
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            border: 3px solid var(--primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .rashi-box {
            background: #fff;
            border: 1px solid var(--border-color);
            position: relative;
            padding: 8px;
            min-height: 0;
            font-size: 0.875rem;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .rashi-box:hover {
            background: rgba(124, 67, 189, 0.03);
        }

        .rashi-number {
            font-weight: 700;
            color: var(--text-muted);
            font-size: 0.6875rem;
            margin-bottom: 4px;
            display: none;
        }

        .planet-names {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 3px;
        }

        .planet-names span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(74, 20, 140, 0.2);
        }

        .planet-names span.transit {
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
            color: var(--primary-dark);
        }

        .chart-title {
            grid-area: title;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-size: 0.8125rem;
            font-family: 'Crimson Pro', Georgia, serif;
            letter-spacing: 0.5px;
        }

        /* Grid area placement */
        .b12 { grid-area: b12; }
        .b1  { grid-area: b1; }
        .b2  { grid-area: b2; }
        .b3  { grid-area: b3; }
        .b11 { grid-area: b11; }
        .b4  { grid-area: b4; }
        .b10 { grid-area: b10; }
        .b5  { grid-area: b5; }
        .b9  { grid-area: b9; }
        .b8  { grid-area: b8; }
        .b7  { grid-area: b7; }
        .b6  { grid-area: b6; }

        .rashi-chart { grid-template-areas:
            "b12 b1 b2 b3"
            "b11 title title b4"
            "b10 title title b5"
            "b9 b8 b7 b6"; }

        /* ===== TRANSIT TABLE ===== */
        .transit-table-container {
            margin-top: 20px;
        }

        .transit-table-container h4 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 12px;
            text-align: center;
        }

        /* ===== ANALYSIS SECTION ===== */
        .analysis-section {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
        }

        .analysis-content h3 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .analysis-content h3:first-child {
            margin-top: 0;
        }

        .analysis-content h4 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 20px 0 12px;
        }

        /* ===== TABLES ===== */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: #fff;
        }

        .status-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .status-table th {
            padding: 12px 14px;
            font-weight: 600;
            text-align: left;
            white-space: nowrap;
        }

        .status-table th:first-child {
            border-radius: var(--radius-sm) 0 0 0;
        }

        .status-table th:last-child {
            border-radius: 0 var(--radius-sm) 0 0;
        }

        .status-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .status-table tbody tr:hover {
            background: rgba(124, 67, 189, 0.04);
        }

        .status-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-table tbody tr:last-child td:first-child {
            border-radius: 0 0 0 var(--radius-sm);
        }

        .status-table tbody tr:last-child td:last-child {
            border-radius: 0 0 var(--radius-sm) 0;
        }

        /* Dasha table specific */
        .dasha-table th,
        .dasha-table td {
            padding: 10px 12px;
            font-size: 0.8125rem;
        }

        .dasha-table th:first-child,
        .dasha-table td:first-child,
        .dasha-table th:nth-child(2),
        .dasha-table td:nth-child(2),
        .dasha-table th:nth-child(3),
        .dasha-table td:nth-child(3) {
            text-align: center;
        }

        .dasha-current {
            background: rgba(255, 152, 0, 0.12) !important;
            font-weight: 600;
        }

        /* ===== YES/NO BADGES ===== */
        .yes {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(46, 125, 50, 0.12);
            color: var(--success);
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .yes::before {
            content: '✓';
            font-weight: 700;
        }

        .no {
            color: var(--danger);
            font-weight: 600;
        }

        /* ===== DASHA NAVIGATION ===== */
        .dasha-nav {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: rgba(124, 67, 189, 0.06);
            border-radius: var(--radius-md);
        }

        .dasha-nav-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dasha-nav-label {
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            min-width: 80px;
        }

        .dasha-nav-value {
            font-weight: 700;
            font-size: 0.9375rem;
            color: var(--primary);
            min-width: 40px;
            text-align: center;
        }

        .dasha-nav .btn-icon {
            background: var(--card-bg);
            color: var(--primary);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .dasha-nav .btn-icon:hover {
            border-color: var(--primary-light);
            background: rgba(124, 67, 189, 0.08);
        }

        /* ===== INFO POPUP ===== */
        .info-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: none;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg);
            z-index: 1200;
        }

        .info-popup.active {
            display: block;
        }

        .info-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1199;
            backdrop-filter: blur(2px);
        }

        .info-popup-overlay.active {
            display: block;
        }

        .info-popup .close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: 50%;
            transition: var(--transition);
        }

        .info-popup .close:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .info-popup h4 {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.125rem;
            color: var(--primary);
            margin-bottom: 12px;
            padding-right: 32px;
        }

        .info-popup code {
            display: inline-block;
            background: rgba(124, 67, 189, 0.1);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8125rem;
            margin-top: 8px;
        }

        /* ===== FOOTER ===== */
        .author-footer {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: rgba(255, 255, 255, 0.9);
            padding: 32px 24px;
            text-align: center;
            margin-top: 32px;
        }

        .author-footer .title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: white;
        }

        .author-footer a {
            color: var(--accent-light);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .author-footer a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .author-footer .email {
            margin-top: 12px;
            font-size: 0.9375rem;
        }

        /* ===== CSV ERRORS ===== */
        .csv-errors {
            margin: 8px 0 0 0;
            padding-left: 20px;
            color: var(--danger);
            font-size: 0.8125rem;
        }

        .csv-errors li {
            margin-bottom: 4px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-section {
                max-width: 420px;
                margin: 0 auto;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }

            .app-header {
                padding: 20px 16px 24px;
            }

            .logo-container img {
                max-width: 80px;
            }

            .controls-section {
                margin: -16px 12px 16px;
                padding: 16px;
            }

            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }

            .control-label {
                font-size: 0.8125rem;
            }

            .form-control {
                width: 100%;
                min-width: unset;
            }

            .btn {
                width: 100%;
                padding: 12px 16px;
            }

            .main-container {
                padding: 0 12px 20px;
            }

            .rashi-chart {
                max-width: 100%;
            }

            .rashi-box {
                padding: 6px;
                font-size: 0.75rem;
            }

            .planet-names span {
                padding: 2px 4px;
                font-size: 0.6875rem;
            }

            .analysis-section {
                padding: 16px;
            }

            .table-wrapper {
                margin: 0 -4px;
                border-radius: 0;
            }

            .status-table {
                font-size: 0.8125rem;
            }

            .status-table th,
            .status-table td {
                padding: 10px 8px;
            }

            .dasha-nav {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .dasha-nav-group {
                justify-content: space-between;
            }

            .dasha-nav-label {
                min-width: auto;
            }

            .author-footer {
                padding: 24px 16px;
            }
        }

        @media (max-width: 480px) {
            .rashi-chart {
                border-width: 2px;
            }

            .rashi-box {
                padding: 4px;
            }

            .planet-names {
                gap: 2px;
            }

            .planet-names span {
                font-size: 0.625rem;
                padding: 1px 3px;
            }

            .chart-title {
                font-size: 0.6875rem;
            }

            .status-table th,
            .status-table td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .app-header {
                background: #fff !important;
                color: #000;
                box-shadow: none;
            }

            .controls-section,
            .info-icon,
            .dasha-nav .btn-icon {
                display: none !important;
            }

            .main-container {
                display: block;
            }

            .chart-section,
            .analysis-section {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<!-- Header -->
<header class="app-header">
    <div class="logo-container">
        <a class="logo-link" href="https://vaiswanara.com" aria-label="Visit vaiswanara.com">
            <img src="logo.gif" alt="Logo" />
        </a>
        <h1 class="app-title">Double Transit WebApp</h1>
        <div class="app-subtitle">Natal &amp; Transit Marriage Yoga Analyzer</div>
    </div>
</header>

<!-- Controls Section -->
<section class="controls-section">
    <div class="controls-grid">
        <!-- Row 1: Natal & Transit -->
        <div class="control-row">
            <div class="control-group" style="flex: 2;">
                <label class="control-label" for="natalInput">Natal Planets</label>
                <span id="infoNatal" class="info-icon" title="Info">i</span>
                <input id="natalInput" class="form-control" type="text" placeholder="2,10,8,6,10,7,10,6,2,8" />
                <button id="loadNatalBtn" class="btn btn-primary">Load Natal</button>
            </div>
            <div class="control-group">
                <label class="control-label" for="transitDate">Transit Date:</label>
                <input id="transitDate" class="form-control" type="date" />
                <button id="loadTransitBtn" class="btn btn-primary">Load Transit</button>
            </div>
        </div>
        <div id="natalMessage" class="message"></div>

        <!-- Row 2: DOB & Dasha -->
        <div class="control-row">
            <div class="control-group">
                <label class="control-label" for="dobInput">DOB:</label>
                <input id="dobInput" class="form-control" type="date" />
            </div>
            <div class="control-group">
                <label class="control-label" for="moonDegInput">Moon long:</label>
                <input id="moonDegInput" class="form-control" type="text" placeholder="e.g. 12.34" />
            </div>
            <div class="control-group">
                <button id="calcDashaBtn" class="btn btn-primary">Calculate Dasha</button>
                <div id="dataMessage" class="message" style="margin: 0;"></div>
            </div>
        </div>
        <div id="dashaMessage" class="message"></div>
    </div>
</section>

<!-- Info Popup -->
<div id="infoPopupOverlay" class="info-popup-overlay"></div>
<div id="infoPopup" class="info-popup" role="dialog" aria-hidden="true">
    <span class="close" id="infoClose">✕</span>
    <h4>How to enter Natal Planets</h4>
    <p>Enter Natal Planets in this order:</p>
    <code>Lg,Su,Ch,Ku,Bu,Gu,Sk,Sa,Ra,Ke</code>
</div>

<!-- Main Content -->
<main class="main-container">
    <!-- Chart Column -->
    <div class="chart-section">
        <h3 class="section-title">Natal Chart (with Transit)</h3>
        <div class="rashi-chart natal simple" id="natalChart">
            <div class="rashi-box b12"><span class="rashi-number">12</span><div class="planet-names" id="natal-box12"></div></div>
            <div class="rashi-box b1"><span class="rashi-number">1</span><div class="planet-names" id="natal-box1"></div></div>
            <div class="rashi-box b2"><span class="rashi-number">2</span><div class="planet-names" id="natal-box2"></div></div>
            <div class="rashi-box b3"><span class="rashi-number">3</span><div class="planet-names" id="natal-box3"></div></div>

            <div class="rashi-box b11"><span class="rashi-number">11</span><div class="planet-names" id="natal-box11"></div></div>
            <div class="chart-title">Rashi Chakra</div>
            <div class="rashi-box b4"><span class="rashi-number">4</span><div class="planet-names" id="natal-box4"></div></div>

            <div class="rashi-box b10"><span class="rashi-number">10</span><div class="planet-names" id="natal-box10"></div></div>
            <div class="rashi-box b5"><span class="rashi-number">5</span><div class="planet-names" id="natal-box5"></div></div>

            <div class="rashi-box b9"><span class="rashi-number">9</span><div class="planet-names" id="natal-box9"></div></div>
            <div class="rashi-box b8"><span class="rashi-number">8</span><div class="planet-names" id="natal-box8"></div></div>
            <div class="rashi-box b7"><span class="rashi-number">7</span><div class="planet-names" id="natal-box7"></div></div>
            <div class="rashi-box b6"><span class="rashi-number">6</span><div class="planet-names" id="natal-box6"></div></div>
        </div>
        <div id="transitTable" class="transit-table-container"></div>
    </div>

    <!-- Analysis Column -->
    <div class="analysis-section">
        <div class="analysis-content" id="analysis"></div>
    </div>
</main>

<!-- Footer -->
<footer class="author-footer">
    <div class="title">About the Author</div>
    <div>
        This application was created by Srikanth Dharmavaram as a teaching aid for students of Vedic Astrology.
        It is built with the aim of simplifying complex concepts like Dasha timing and Double Transit activation for practical learning and research.
    </div>
    <div class="email"><a href="https://vaiswanara.com" target="_blank" rel="noopener">https://vaiswanara.com</a></div>
</footer>

<script src="dasha.js"></script>
<script>
    // ---------- INPUT DATA ----------
    const natal = {
        Lagna: 4,
        Su: 8, Ch: 8, Ku: 5, Bu: 8, Gu: 8,
        Sk: 7, Sa: 11, Ra: 7, Ke: 1
    };

    const transit = {
        Lagna: 6,
        Su: 4, Ch: 7, Ku: 2, Bu: 5, Gu: 2,
        Sk: 5, Sa: 11, Ra: 6
    };

    // For now this simple boolean controls whether current dasha supports marriage timing
    const dashaSupportsMarriage = true;

    const signs = [
        "1 Mesha", "2 Vrishabha", "3 Mithuna", "4 Karkataka",
        "5 Simha", "6 Kanya", "7 Tula", "8 Vrischika",
        "9 Dhanu", "10 Makara", "11 Kumbha", "12 Meena"
    ];

    // ---------- RASHI CHART POPULATION ----------

    function clearChart(prefix) {
        for (let i = 1; i <= 12; i++) {
            const el = document.getElementById(`${prefix}-box${i}`);
            if (el) el.innerHTML = "";
        }
    }

    function populateChart(prefix, data) {
        clearChart(prefix);
        for (let planet in data) {
            const sign = data[planet];
            const box = document.getElementById(`${prefix}-box${sign}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = (planet === 'Lagna') ? 'Lg' : planet;
                box.appendChild(span);
            }
        }
    }

    // populate natal chart initially
    populateChart("natal", natal);
    addTransitToChart(transit);

    // ---------- TRANSIT CSV LOADING & DATE NAVIGATION ----------
    (function() {
        let dateInput = document.getElementById('transitDate');
        // replace input element with a fresh clone to ensure no old handlers remain
        const _clone = dateInput.cloneNode(true);
        dateInput.parentNode.replaceChild(_clone, dateInput);
        dateInput = _clone;

        const loadBtn = document.getElementById('loadTransitBtn');
        const fileInput = document.getElementById('csvFileInput');
        const dataMessage = document.getElementById('dataMessage');

        function pad(n){ return n<10? '0'+n: ''+n; }
        function formatDateDDMMYYYY(d){ return pad(d.getDate()) + '-' + pad(d.getMonth()+1) + '-' + d.getFullYear(); }
        function formatDateForInput(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }

        // flexible parser for various date formats we might encounter in CSV
        function parseDateFlexible(s){
            if (!s) return null;
            s = s.trim();
            s = s.replace(/\//g, '-');
            let m;
            // ISO YYYY-MM-DD (from input[type=date]) -> create local date at midnight
            if (m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/)){
                const yr = parseInt(m[1],10), mon = parseInt(m[2],10), day = parseInt(m[3],10);
                return new Date(yr, mon-1, day);
            }
            if (m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{2,4})$/)){
                let day = parseInt(m[1],10), mon = parseInt(m[2],10), yr = parseInt(m[3],10);
                if (yr < 100) yr += 2000;
                return new Date(yr, mon-1, day);
            }
            if (m = s.match(/^(\d{1,2})-([A-Za-z]+)-(\d{2,4})$/)){
                let day = parseInt(m[1],10), monStr = m[2], yr = parseInt(m[3],10);
                if (yr < 100) yr += 2000;
                const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
                const key = monStr.substring(0,3).toLowerCase();
                if (months.hasOwnProperty(key)){
                    return new Date(yr, months[key], day);
                }
            }
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        function parseCSV(text){
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
            if (!lines.length) return { rows: [], errors: [] };

            // make header-driven parsing robust to presence/absence of D9 or different column orders
            const rawHeader = lines.shift();
            const headerCols = rawHeader.split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, ''));

            const idx = name => headerCols.indexOf(name);
            const idxPlanet = idx('planet') >= 0 ? idx('planet') : 0;
            const idxFrom = idx('fromdate') >= 0 ? idx('fromdate') : 1;
            const idxTo = idx('todate') >= 0 ? idx('todate') : 2;
            const idxDir = idx('direction') >= 0 ? idx('direction') : 3;
            const idxD1 = idx('d1') >= 0 ? idx('d1') : 4;

            const rows = [];
            const errors = [];

            lines.forEach((line, i) => {
                const parts = line.split(',').map(p => p.trim());
                const planet = parts[idxPlanet] || parts[0];
                const fromRaw = parts[idxFrom] || parts[1] || '';
                const toRaw = parts[idxTo] || parts[2] || '';
                const dir = parts[idxDir] || parts[3] || null;
                const d1raw = (parts.length > idxD1 && parts[idxD1]) ? parts[idxD1] : (parts[4] || null);

                const fromDate = parseDateFlexible(fromRaw);
                const toDate = parseDateFlexible(toRaw);

                if (!fromDate) errors.push({ line: i+2, field: 'FromDate', value: fromRaw });
                if (!toDate) errors.push({ line: i+2, field: 'ToDate', value: toRaw });

                rows.push({
                    Planet: planet,
                    FromDate: fromDate,
                    ToDate: toDate,
                    Direction: dir,
                    D1: d1raw ? parseInt(d1raw,10) : null,
                    rawLine: line
                });
            });

            return { rows, errors };
        }

        function findPlanetTransitOnDate(rows, planetName, date){
            return rows.find(r => r.Planet && r.Planet.toLowerCase() === planetName.toLowerCase() && r.FromDate && r.ToDate && date >= r.FromDate && date <= r.ToDate) || null;
        }

        function applyTransitFromRows(rows, date){
            const g = findPlanetTransitOnDate(rows, 'Guru', date);
            const s = findPlanetTransitOnDate(rows, 'Shani', date);
            let found = false;
            if (g && g.D1) { transit.Gu = g.D1; found = true; }
            if (s && s.D1) { transit.Sa = s.D1; found = true; }
            // Redraw natal chart with updated transit data
            addTransitToChart(transit);
            return { found, guruRow: g, shaniRow: s };
        }

        async function fetchCSVAndApply(date){
            try{
                const res = await fetch('Transit_Guru-Shani.csv');
                if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                const txt = await res.text();
                const parsed = parseCSV(txt);
                const rows = parsed.rows || [];
                const errors = parsed.errors || [];

                if (errors && errors.length){
                    const list = errors.map(e => `<li>Line ${e.line}: invalid ${e.field} ('${e.value}')</li>`).join('');
                    dataMessage.innerHTML = `<span class="no">CSV contains malformed dates:</span><ul class="csv-errors">${list}</ul>`;
                    console.warn('CSV date errors', errors);
                }

                const resObj = applyTransitFromRows(rows, date);
                if (resObj.found){
                    analyzeMarriage();
                    displayTransitTable(date, resObj.guruRow, resObj.shaniRow);
                    if (!errors || !errors.length) {
                        dataMessage.className = 'message message-success';
                        dataMessage.textContent = `Loaded transit for ${formatDateDDMMYYYY(date)} from CSV.`;
                    } else {
                        dataMessage.innerHTML += `<div>Loaded transit for ${formatDateDDMMYYYY(date)} from CSV (some rows had errors).</div>`;
                    }
                } else {
                    if (!errors || !errors.length){
                        dataMessage.className = 'message message-info';
                        dataMessage.textContent = `No Guru/Shani rows found in CSV for ${formatDateDDMMYYYY(date)}. Using fallback transit.`;
                    } else {
                        dataMessage.innerHTML += `<div>No Guru/Shani rows usable for ${formatDateDDMMYYYY(date)}. Using fallback transit.</div>`;
                    }
                    displayTransitTable(date, null, null);
                }
            } catch (err){
                console.warn(err);
                dataMessage.className = 'message message-error';
                dataMessage.textContent = 'Could not fetch CSV automatically. You can upload the CSV with the file picker.';
                displayTransitTable(date, null, null);
            }
        }

        // file input fallback
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = function(ev){
                try{
                    const parsed = parseCSV(ev.target.result);
                    const rows = parsed.rows || [];
                    const errors = parsed.errors || [];

                    if (errors.length){
                        const list = errors.map(er => `<li>Line ${er.line}: invalid ${er.field} ('${er.value}')</li>`).join('');
                        dataMessage.innerHTML = `<span class="no">CSV contains malformed dates:</span><ul class="csv-errors">${list}</ul>`;
                        console.warn('CSV date errors', errors);
                    }

                    const date = parseDateFlexible(dateInput.value) || new Date();
                    const resObj = applyTransitFromRows(rows, date);
                    if (resObj.found){
                        analyzeMarriage();
                        displayTransitTable(date, resObj.guruRow, resObj.shaniRow);
                        if (errors.length){
                            dataMessage.innerHTML += `<div>Loaded transit for ${formatDateDDMMYYYY(date)} from uploaded CSV (some rows had errors).</div>`;
                        } else {
                            dataMessage.className = 'message message-success';
                            dataMessage.textContent = `Loaded transit for ${formatDateDDMMYYYY(date)} from uploaded CSV.`;
                        }
                    } else {
                        dataMessage.innerHTML += `<div>No Guru/Shani rows found in uploaded CSV for ${formatDateDDMMYYYY(date)}.</div>`;
                        displayTransitTable(date, null, null);
                    }
                }catch(err){
                    console.warn(err);
                    dataMessage.className = 'message message-error';
                    dataMessage.textContent = 'Error parsing uploaded CSV.';
                }
            };
            reader.readAsText(f);
            });
        }

        // Load button clicked
        loadBtn.addEventListener('click', () => {
            const date = parseDateFlexible(dateInput.value);
            if (!date){ 
                dataMessage.className = 'message message-error';
                dataMessage.textContent = 'Please select a valid date.'; 
                return; 
            }
            fetchCSVAndApply(date);
        });

        // Simple handler: Enter triggers load.
        dateInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { loadBtn.click(); }
        });

        // Auto-fetch when date changes (supports keyboard/year navigation). Debounced to avoid excessive fetches.
        let dateInputTimer = null;
        function scheduleFetchDate(){
            const date = parseDateFlexible(dateInput.value);
            if (!date){ 
                dataMessage.className = 'message message-error';
                dataMessage.textContent = 'Please select a valid date.'; 
                return; 
            }
            dataMessage.className = 'message message-info';
            dataMessage.textContent = 'Loading transit for ' + formatDateDDMMYYYY(date) + '...';
            if (dateInputTimer) clearTimeout(dateInputTimer);
            dateInputTimer = setTimeout(() => { fetchCSVAndApply(date); dateInputTimer = null; }, 300);
        }
        dateInput.addEventListener('change', scheduleFetchDate);
        dateInput.addEventListener('input', scheduleFetchDate);

        function displayTransitTable(date, guruRow, shaniRow){
            const el = document.getElementById('transitTable'); if (!el) return;
            function rowHtml(planetName, row){
                if (!row || !row.D1){
                    return `<tr><td>${planetName}</td><td colspan="3">No data</td></tr>`;
                }
                const dir = row.Direction || '';
                const from = row.FromDate ? formatDateDDMMYYYY(row.FromDate) : 'N/A';
                const to = row.ToDate ? formatDateDDMMYYYY(row.ToDate) : 'N/A';
                return `<tr><td>${planetName}</td><td>${dir}</td><td>${from}</td><td>${to}</td></tr>`;
            }
            let html = `<h4>Transit Table (Guru & Shani)</h4>`;
            html += `<div class="table-wrapper">`;
            html += `<table class="status-table" style="margin-top:8px; width:100%;"><thead><tr><th>Planet</th><th>Dir</th><th>From</th><th>To</th></tr></thead><tbody>`;
            html += rowHtml('Shani', shaniRow);
            html += rowHtml('Guru', guruRow);
            html += `</tbody></table></div>`;

            el.innerHTML = html;
        }

        // NATAL INPUT HANDLING
        const natalInput = document.getElementById('natalInput');
        const loadNatalBtn = document.getElementById('loadNatalBtn');
        const natalMessage = document.getElementById('natalMessage');

        const natalKeys = ['Lagna','Su','Ch','Ku','Bu','Gu','Sk','Sa','Ra','Ke'];

        function applyNatalArray(arr){
            // arr is array of numbers length 10
            natalKeys.forEach((k,i) => { natal[k] = arr[i]; });
            populateChart('natal', natal);
            addTransitToChart(transit);
            analyzeMarriage();
        }

        function parseNatalValue(s){
            if (!s) return { ok: false, error: 'Empty input' };
            const parts = s.split(/[\s,]+/).map(p => p.trim()).filter(p => p.length);
            if (parts.length !== 10) return { ok: false, error: 'Expected exactly 10 numbers (found ' + parts.length + ')' };
            const nums = parts.map(p => parseInt(p,10));
            for (let i=0;i<nums.length;i++){
                const n = nums[i];
                if (!Number.isInteger(n) || n < 1 || n > 12) return { ok: false, error: 'Value at position ' + (i+1) + ' is invalid: ' + parts[i] };
            }
            return { ok: true, nums };
        }

        loadNatalBtn.addEventListener('click', () => {
            const parsed = parseNatalValue(natalInput.value);
            if (!parsed.ok){ 
                natalMessage.className = 'message message-error';
                natalMessage.innerHTML = parsed.error; 
                return; 
            }
            applyNatalArray(parsed.nums);
            natalMessage.className = 'message message-success';
            natalMessage.innerHTML = 'Natal chart updated successfully';
        });
        natalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadNatalBtn.click(); });

        // set default date to today (ISO format for date input)
        dateInput.value = formatDateForInput(new Date());
        // set default DOB to 02-12-1994 (ISO yyyy-mm-dd)
        const dobInput = document.getElementById('dobInput'); if (dobInput) dobInput.value = formatDateForInput(new Date(1994,11,2));
        // set default Moon Longitude
        const moonDeg = document.getElementById('moonDegInput'); if (moonDeg) moonDeg.value = '11.82';
        // set default natal input from current natal object
        natalInput.value = `${natal.Lagna},${natal.Su},${natal.Ch},${natal.Ku},${natal.Bu},${natal.Gu},${natal.Sk},${natal.Sa},${natal.Ra},${natal.Ke}`;

        // try auto-fetch for today's date
        fetchCSVAndApply(new Date());
    })();

    // Calculate button hookup: re-run analysis which will include dasha table if inputs provided
    document.getElementById('calcDashaBtn').addEventListener('click', () => {
        analyzeMarriage();
        const msg = document.getElementById('dashaMessage'); 
        if (msg) {
            msg.className = 'message message-success';
            msg.textContent = 'Dasha calculated (see Dasha table below).';
        }
    });

    // Info popup handlers for Natal Planets
    (function(){
        const info = document.getElementById('infoNatal');
        const popup = document.getElementById('infoPopup');
        const overlay = document.getElementById('infoPopupOverlay');
        const close = document.getElementById('infoClose');
        
        function openPopup() {
            popup.classList.add('active');
            overlay.classList.add('active');
            popup.setAttribute('aria-hidden','false');
        }
        
        function closePopup() {
            popup.classList.remove('active');
            overlay.classList.remove('active');
            popup.setAttribute('aria-hidden','true');
        }
        
        if (info && popup){
            info.addEventListener('click', openPopup);
            close.addEventListener('click', closePopup);
            overlay.addEventListener('click', closePopup);
            window.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape' && popup.classList.contains('active')) {
                    closePopup();
                }
            });
        }
    })();

    // ---------- ADD TRANSIT PLANETS TO NATAL CHART ----------

    /**
     * addTransitToChart(transitData)
     * Adds transit planets (Tg, Ts) to the existing natal chart boxes
     * 
     * @param {object} transitData - Object with transit positions: {Gu: 2, Sa: 11, ...}
     */
    function addTransitToChart(transitData) {
        // Clear any previous transit additions by resetting chart
        populateChart('natal', natal);
        
        // Add transit planets to chart
        if (transitData.Gu && transitData.Gu >= 1 && transitData.Gu <= 12) {
            const box = document.getElementById(`natal-box${transitData.Gu}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = 'Tg';
                span.classList.add('transit');
                box.appendChild(span);
            }
        }
        
        if (transitData.Sa && transitData.Sa >= 1 && transitData.Sa <= 12) {
            const box = document.getElementById(`natal-box${transitData.Sa}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = 'Ts';
                span.classList.add('transit');
                box.appendChild(span);
            }
        }
    }

    // ---------- TRANSIT ACTIVATION FOR MARRIAGE ----------

    // helper: shift sign by steps
    function addSign(sign, step) { return ((sign - 1 + step) % 12) + 1; }

    // aspect targets for Jupiter (Guru) and Saturn (Shani)
    function aspectTargets(planetCode, sign) {
        if (!sign) return [];
        if (planetCode === 'Gu') return [addSign(sign,4), addSign(sign,6), addSign(sign,8)]; // 5th,7th,9th
        if (planetCode === 'Sa') return [addSign(sign,2), addSign(sign,6), addSign(sign,9)]; // 3rd,7th,10th
        return [];
    }

    // reusable checks
    function isPosited(transitSign, targetSign){ return !!(transitSign && targetSign && transitSign === targetSign); }
    function isConjunct(transitSign, natalSign){ return isPosited(transitSign, natalSign); }
    function isAspecting(planetCode, transitSign, targetSign){
        if (!transitSign || !targetSign) return false;
        const a = aspectTargets(planetCode, transitSign);
        return a.includes(targetSign);
    }

    // build and return the Transit Activation table HTML (does not mutate DOM)
    function renderTransitActivationHtml(){
        const guruSign = transit.Gu;
        const shaniSign = transit.Sa;

        const seventhHouse = addSign(natal.Lagna, 6);
        const seventhLord = getLord(seventhHouse);
        const seventhLordSign = natal[seventhLord];
        const lagna = natal.Lagna;
        const lagnaLord = getLord(lagna);
        const lagnaLordSign = natal[lagnaLord];
        const janmaRashi = natal.Ch;
        const secondHouse = addSign(natal.Lagna, 1);
        const eleventhHouse = addSign(natal.Lagna, 10);
        const natalSecondLord = getLord(secondHouse);
        const natalEleventhLord = getLord(eleventhHouse);
        const planetKeys = ['Su','Ch','Ku','Bu','Gu','Sk','Sa','Ra','Ke'];
        const natalSeventhHousePlanets = planetKeys.filter(p => natal[p] === seventhHouse);

        const rows = [
            { label: 'Posited in 7th House', guru: isPosited(guruSign, seventhHouse), shani: isPosited(shaniSign, seventhHouse) },
            { label: 'Aspecting 7th House', guru: isAspecting('Gu', guruSign, seventhHouse), shani: isAspecting('Sa', shaniSign, seventhHouse) },
            { label: 'Conjunction with 7th Lord', guru: isConjunct(guruSign, seventhLordSign), shani: isConjunct(shaniSign, seventhLordSign) },
            { label: 'Aspecting 7th Lord', guru: isAspecting('Gu', guruSign, seventhLordSign), shani: isAspecting('Sa', shaniSign, seventhLordSign) },
            { label: 'Posited in Lagna', guru: isPosited(guruSign, lagna), shani: isPosited(shaniSign, lagna) },
            { label: 'Aspecting Lagna', guru: isAspecting('Gu', guruSign, lagna), shani: isAspecting('Sa', shaniSign, lagna) },
            { label: 'Conjoined with Lagna Lord', guru: isConjunct(guruSign, lagnaLordSign), shani: isConjunct(shaniSign, lagnaLordSign) },
            { label: 'Aspecting Lagna Lord', guru: isAspecting('Gu', guruSign, lagnaLordSign), shani: isAspecting('Sa', shaniSign, lagnaLordSign) },
            { label: 'Posited in Janma Rashi', guru: isPosited(guruSign, janmaRashi), shani: isPosited(shaniSign, janmaRashi) },
            { label: 'Aspecting Janma Rashi', guru: isAspecting('Gu', guruSign, janmaRashi), shani: isAspecting('Sa', shaniSign, janmaRashi) }
        ];

        let html = `<h3>Transit Activation for Marriage</h3>`;
        html += `<div class="table-wrapper"><table class="status-table"><thead><tr><th>Parameter</th><th>Guru</th><th>Shani</th></tr></thead><tbody>`;
        rows.forEach(r => {
            html += `<tr><td>${r.label}</td><td>${r.guru ? '<span class="yes">Yes</span>' : ''}</td><td>${r.shani ? '<span class="yes">Yes</span>' : ''}</td></tr>`;
        });
        html += `</tbody></table></div>`;

        // Append Dasha table if DOB and Moon degrees available
        try {
            const dobVal = document.getElementById('dobInput') ? document.getElementById('dobInput').value : null;
            const moonDegVal = document.getElementById('moonDegInput') ? document.getElementById('moonDegInput').value : null;
            const moonRashi = natal && natal.Ch ? natal.Ch : null; // moon rashi from natal data
            if (dobVal && moonDegVal !== null && moonRashi) {
                const res = Dasha.calculateVimshottariDasha(dobVal, moonRashi, parseFloat(moonDegVal));
                if (!res.error && res.rows && res.rows.length) {
                    // Group pratyantar rows by Mahadasha -> Antardasha
                    const groups = {};
                    const order = [];
                    res.rows.forEach(r => {
                        const m = r.maha;
                        const a = r.antar;
                        if (!groups[m]) {
                            groups[m] = { antars: {}, orderAntar: [], start: r.from, end: r.to };
                            order.push(m);
                        }
                        if (!groups[m].antars[a]) {
                            groups[m].antars[a] = { rows: [], start: r.from, end: r.to };
                            groups[m].orderAntar.push(a);
                        }
                        groups[m].antars[a].rows.push(r);
                        if (r.from < groups[m].antars[a].start) groups[m].antars[a].start = r.from;
                        if (r.to > groups[m].antars[a].end) groups[m].antars[a].end = r.to;
                        if (r.from < groups[m].start) groups[m].start = r.from;
                        if (r.to > groups[m].end) groups[m].end = r.to;
                    });

                    // reference date: Transit Date if present else today
                    const refDateStr = (document.getElementById('transitDate') && document.getElementById('transitDate').value) || null;
                    let refDate = refDateStr ? new Date(refDateStr) : new Date();
                    if (isNaN(refDate)) refDate = new Date();

                    let currentMahaIdx = order.findIndex(m => refDate >= groups[m].start && refDate <= groups[m].end);
                    if (currentMahaIdx === -1) {
                        // try finding next upcoming mahadasha starting after refDate
                        currentMahaIdx = order.findIndex(m => groups[m].start > refDate);
                        if (currentMahaIdx === -1) currentMahaIdx = 0; // fallback
                    }
                    const mahaKey = order[currentMahaIdx];
                    const antarOrder = groups[mahaKey].orderAntar;
                    let currentAntarIdx = antarOrder.findIndex(a => refDate >= groups[mahaKey].antars[a].start && refDate <= groups[mahaKey].antars[a].end);
                    if (currentAntarIdx === -1) {
                        currentAntarIdx = antarOrder.findIndex(a => groups[mahaKey].antars[a].start > refDate);
                        if (currentAntarIdx === -1) currentAntarIdx = 0;
                    }
                    const antarKey = antarOrder[currentAntarIdx];
                    const pratyRows = groups[mahaKey].antars[antarKey].rows;
                    let currentPratyIdx = pratyRows.findIndex(p => refDate >= p.from && refDate <= p.to);
                    if (currentPratyIdx === -1) {
                        currentPratyIdx = pratyRows.findIndex(p => p.from > refDate);
                        if (currentPratyIdx === -1) currentPratyIdx = 0;
                    }
                    // store dasha groups and current index for navigation
                    window._dashaState = { groups, order, currentMahaIdx, currentAntarIdx, currentPratyIdx };

                    const currentMaha = mahaKey;
                    const currentAntar = antarKey;
                    const currentPraty = pratyRows[currentPratyIdx] ? pratyRows[currentPratyIdx].pratyantara : null;
                    const matchesDasha = (planets, target) => !!(planets && target && planets.includes(target));
                    const dashaSupportRows = [
                        { label: '7th Lord Dasha', planets: [seventhLord] },
                        { label: 'Planets in Natal 7th House Dasha', planets: natalSeventhHousePlanets },
                        { label: 'Venus (Shukra) Dasha', planets: ['Sk'] },
                        { label: '2nd Lord Dasha', planets: [natalSecondLord] },
                        { label: '11th Lord Dasha', planets: [natalEleventhLord] }
                    ];

                    html += `<h4>Dasha Support for Marriage</h4>`;
                    html += `<div class="table-wrapper"><table class="status-table"><thead><tr><th>Parameter</th><th>Maha</th><th>Antar</th><th>Praty</th></tr></thead><tbody>`;
                    dashaSupportRows.forEach(r => {
                        const mahaYes = matchesDasha(r.planets, currentMaha);
                        const antarYes = matchesDasha(r.planets, currentAntar);
                        const pratyYes = matchesDasha(r.planets, currentPraty);
                        html += `<tr><td>${r.label}</td><td>${mahaYes ? '<span class="yes">Yes</span>' : ''}</td><td>${antarYes ? '<span class="yes">Yes</span>' : ''}</td><td>${pratyYes ? '<span class="yes">Yes</span>' : ''}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;

                    html += `<h4>Dasha (Mahadasha &rarr; Antardasha &rarr; Pratyantara)</h4>`;
                    html += `<div class="dasha-nav">
                        <div class="dasha-nav-group">
                            <span class="dasha-nav-label">Mahadasha</span>
                            <button id="maha-prev" class="btn btn-icon">&lt;</button>
                            <span id="maha-indicator" class="dasha-nav-value">${order[currentMahaIdx]}</span>
                            <button id="maha-next" class="btn btn-icon">&gt;</button>
                        </div>
                        <div class="dasha-nav-group">
                            <span class="dasha-nav-label">Antardasha</span>
                            <button id="antar-prev" class="btn btn-icon">&lt;</button>
                            <span id="antar-indicator" class="dasha-nav-value">${antarOrder[currentAntarIdx]}</span>
                            <button id="antar-next" class="btn btn-icon">&gt;</button>
                        </div>
                        <div class="dasha-nav-group">
                            <span class="dasha-nav-label">Pratyantara</span>
                            <button id="praty-prev" class="btn btn-icon">&lt;</button>
                            <span id="praty-indicator" class="dasha-nav-value">${pratyRows[currentPratyIdx].pratyantara}</span>
                            <button id="praty-next" class="btn btn-icon">&gt;</button>
                        </div>
                    </div>`;

                    html += `<div class="table-wrapper"><table id="dasha-table" class="status-table dasha-table" style="width:100%;"><thead><tr><th>Dasha</th><th>From</th><th>To</th></tr></thead><tbody id="dasha-tbody"></tbody></table></div>`;
                }
            }
        } catch (e) { console.warn('Dasha calc failed', e); }

        console.log('Transit activation table constructed', {guruSign, shaniSign, rows});
        return html;
    }

    // Render Event Manifestation Houses (Marriage Materialisation)
    function renderEventManifestationTable(){
        const guruSign = transit.Gu;
        const shaniSign = transit.Sa;

        if (!natal || !natal.Lagna){
            // return an informational message as HTML
            return `<p class="no">No natal data to evaluate event manifestation houses.</p>`;
        }

        const secondHouse = addSign(natal.Lagna, 1);
        const eleventhHouse = addSign(natal.Lagna, 10);
        const secondLord = getLord(secondHouse);
        const eleventhLord = getLord(eleventhHouse);

        const rows = [
            { label: 'Posited in 2nd House', guru: isPosited(guruSign, secondHouse), shani: isPosited(shaniSign, secondHouse) },
            { label: 'Aspecting 2nd House', guru: isAspecting('Gu', guruSign, secondHouse), shani: isAspecting('Sa', shaniSign, secondHouse) },
            { label: 'Aspecting 2nd Lord', guru: isAspecting('Gu', guruSign, natal[secondLord]), shani: isAspecting('Sa', shaniSign, natal[secondLord]) },
            { label: 'Conjunction with 2nd Lord', guru: isConjunct(guruSign, natal[secondLord]), shani: isConjunct(shaniSign, natal[secondLord]) },

            { label: 'Posited in 11th House', guru: isPosited(guruSign, eleventhHouse), shani: isPosited(shaniSign, eleventhHouse) },
            { label: 'Aspecting 11th House', guru: isAspecting('Gu', guruSign, eleventhHouse), shani: isAspecting('Sa', shaniSign, eleventhHouse) },
            { label: 'Aspecting 11th Lord', guru: isAspecting('Gu', guruSign, natal[eleventhLord]), shani: isAspecting('Sa', shaniSign, natal[eleventhLord]) },
            { label: 'Conjunction with 11th Lord', guru: isConjunct(guruSign, natal[eleventhLord]), shani: isConjunct(shaniSign, natal[eleventhLord]) }
        ];

        // Event manifestation table removed per user request
        return '';
    }

    // main analyzeMarriage entry now renders both tables stacked (one below the other)
    function analyzeMarriage(){
        const left = renderTransitActivationHtml();
        const right = renderEventManifestationTable();
        document.getElementById('analysis').innerHTML = left + '<div style="height:12px;"></div>' + right;
        // attach dasha navigation handlers if dasha state exists
        attachDashaNavHandlers();
    }

    function attachDashaNavHandlers(){
        try {
            const state = window._dashaState;
            if (!state || !state.order || !state.groups) return;
            const mahaPrev = document.getElementById('maha-prev');
            const mahaNext = document.getElementById('maha-next');
            const mahaIndicator = document.getElementById('maha-indicator');
            const antarPrev = document.getElementById('antar-prev');
            const antarNext = document.getElementById('antar-next');
            const antarIndicator = document.getElementById('antar-indicator');
            const pratyPrev = document.getElementById('praty-prev');
            const pratyNext = document.getElementById('praty-next');
            const pratyIndicator = document.getElementById('praty-indicator');
            const tbody = document.getElementById('dasha-tbody');
            if (!mahaIndicator || !antarIndicator || !pratyIndicator || !tbody) return;

            function currentMahaKey(){ return state.order[state.currentMahaIdx]; }
            function currentAntarOrder(){
                const mahaKey = currentMahaKey();
                return state.groups[mahaKey].orderAntar;
            }
            function currentAntarKey(){
                const antarOrder = currentAntarOrder();
                return antarOrder[state.currentAntarIdx];
            }
            function currentPratyRows(){
                const mahaKey = currentMahaKey();
                const antarKey = currentAntarKey();
                return state.groups[mahaKey].antars[antarKey].rows;
            }

            function renderState(){
                const mahaKey = currentMahaKey();
                const antarOrder = currentAntarOrder();
                const antarKey = currentAntarKey();
                const pratyRows = currentPratyRows();
                const praty = pratyRows[state.currentPratyIdx];
                mahaIndicator.textContent = mahaKey || '';
                antarIndicator.textContent = antarKey || '';
                pratyIndicator.textContent = praty ? praty.pratyantara : '';

                tbody.innerHTML = '';
                pratyRows.forEach((r, idx) => {
                    const label = `${r.maha}-${r.antar}-${r.pratyantara}`;
                    const rowClass = (idx === state.currentPratyIdx) ? 'dasha-current' : '';
                    const tr = `<tr class="${rowClass}"><td>${label}</td><td>${Dasha.formatDate(r.from)}</td><td>${Dasha.formatDate(r.to)}</td></tr>`;
                    tbody.innerHTML += tr;
                });
            }

            function setMahaIdx(nextIdx){
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= state.order.length) nextIdx = state.order.length - 1;
                state.currentMahaIdx = nextIdx;
                state.currentAntarIdx = 0;
                state.currentPratyIdx = 0;
                renderState();
            }
            function setAntarIdx(nextIdx){
                const antarOrder = currentAntarOrder();
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= antarOrder.length) nextIdx = antarOrder.length - 1;
                state.currentAntarIdx = nextIdx;
                state.currentPratyIdx = 0;
                renderState();
            }
            function setPratyIdx(nextIdx){
                const pratyRows = currentPratyRows();
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= pratyRows.length) nextIdx = pratyRows.length - 1;
                state.currentPratyIdx = nextIdx;
                renderState();
            }

            if (mahaPrev) mahaPrev.addEventListener('click', () => { setMahaIdx(state.currentMahaIdx - 1); });
            if (mahaNext) mahaNext.addEventListener('click', () => { setMahaIdx(state.currentMahaIdx + 1); });
            if (antarPrev) antarPrev.addEventListener('click', () => { setAntarIdx(state.currentAntarIdx - 1); });
            if (antarNext) antarNext.addEventListener('click', () => { setAntarIdx(state.currentAntarIdx + 1); });
            if (pratyPrev) pratyPrev.addEventListener('click', () => { setPratyIdx(state.currentPratyIdx - 1); });
            if (pratyNext) pratyNext.addEventListener('click', () => { setPratyIdx(state.currentPratyIdx + 1); });

            renderState();
        } catch (e){ console.warn('attachDashaNavHandlers failed', e); }
    }

    function getLord(sign) {
        const lords = {
            1: "Ku", 2: "Sk", 3: "Bu", 4: "Ch",
            5: "Su", 6: "Bu", 7: "Sk", 8: "Ku",
            9: "Gu", 10: "Sa", 11: "Sa", 12: "Gu"
        };
        return lords[sign];
    }

    analyzeMarriage();
</script>

</body>
</html>
