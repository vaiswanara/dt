<!DOCTYPE html>
<html>
<head>
    <title>Marriage Yoga Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg,#f5f2ea,#fff);
            color: #222;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 10px;
        }

        .main-row {
            display: grid;
            grid-template-columns: minmax(220px,320px) 1fr;
            gap: 16px;
            align-items: start;
            margin-top: 12px;
        }
        .chart-column { text-align: center; }

        .rashi-chart {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            grid-template-rows: repeat(4, 100px);
            gap: 0;
            background: white;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
        }

        .rashi-box {
            background: white;
            border: 1px solid #000;
            position: relative;
            padding: 8px;
            min-height: 75px;
            font-size: 16px;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            border-radius: 0;
            display: block;
        }

        .rashi-number {
            font-weight: 700;
            color: #000;
            /* Hidden by user request: hide rashi numbers */
            display: none;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .planet-names {
            margin-top: 3px;
            width: 100%;
            text-align: left;
            font-size: 17px;
            color: #000;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }

        .planet-names span {
            display: inline-block;
            background: transparent;
            color: #000;
            padding: 0 6px 0 0;
            margin: 0 6px 4px 0;
            border-radius: 0;
            font-weight: normal;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: anywhere;
            word-break: normal;
            white-space: nowrap;
            vertical-align: top;
        }

        .chart-title {
            grid-area: title;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            background: white;
            border-radius: 0;
            border: 1px solid #000;
            font-size: 12px;
        }

        /* Grid area placement */
        .b12 { grid-area: b12; }
        .b1  { grid-area: b1; }
        .b2  { grid-area: b2; }
        .b3  { grid-area: b3; }
        .b11 { grid-area: b11; }
        .b4  { grid-area: b4; }
        .b10 { grid-area: b10; }
        .b5  { grid-area: b5; }
        .b9  { grid-area: b9; }
        .b8  { grid-area: b8; }
        .b7  { grid-area: b7; }
        .b6  { grid-area: b6; }

        .rashi-chart { grid-template-areas:
            "b12 b1 b2 b3"
            "b11 title title b4"
            "b10 title title b5"
            "b9 b8 b7 b6"; }

        .analysis {
            margin: 30px auto;
            width: 70%;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
            text-align: left;
        }

        .highlight {
            color: green;
            font-weight: bold;
        }

        /* Marriage Status table styles */
        .status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 15px;
        }
        .status-table th, .status-table td {
            border: 1px solid #eee;
            padding: 8px 10px;
            text-align: left;
        }
        .dasha-table th, .dasha-table td {
            padding: 6px 8px;
            font-size: 14px;
        }
        /* Center Dasha label and date columns */
        .dasha-table th:first-child, .dasha-table td:first-child { text-align: center; }
        .dasha-table th:nth-child(2), .dasha-table td:nth-child(2),
        .dasha-table th:nth-child(3), .dasha-table td:nth-child(3) { text-align: center; }
        .status-table th {
            background: #faf6ef;
            font-weight: 700;
        }
        .yes {
            color: #0b7a21;
            font-weight: 700;
        }
        .no {
            color: #c53030;
            font-weight: 700;
        }
        .dasha-current {
            background: #f2f7ff;
            font-weight: 700;
        }

        .author-footer {
            margin-top: 30px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            padding: 16px 18px;
            text-align: center;
            font-size: 14px;
            color: #333;
        }
        .author-footer .title { font-weight: 600; margin-bottom: 6px; }
        .author-footer .email { margin-top: 6px; color: #444; }

        /* Two-column layout for analysis tables */
        .analysis-grid { display: flex; gap: 18px; align-items: flex-start; }
        .analysis-col { flex: 1; }

        @media (max-width: 900px) {
            .analysis-grid { flex-direction: column; }
        }

        .table-wrapper { overflow-x: auto; width: 100%; }
        .table-wrapper table { min-width: 520px; }

        @media (max-width: 800px) {
            .rashi-chart { grid-template-columns: repeat(4, 70px); grid-template-rows: repeat(4,70px); }
        }

        /* Date input and CSV message */
        #transitDate, #natalInput { border: 1px solid #d8cfc0; border-radius: 4px; }
        #loadTransitBtn, #loadNatalBtn { background: #0366d6; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        #loadTransitBtn:hover, #loadNatalBtn:hover { opacity: 0.95; }
        #dataMessage { font-size: 13px; }
        #natalMessage { font-size: 13px; }
        .natal-help { font-size: 13px; }
        .csv-errors { margin:8px 0 0 0; padding-left: 18px; color: #c53030; }
        .csv-errors li { margin-bottom: 4px; }

        /* Controls styling */
        .controls-wrapper { margin:12px auto; width:70%; text-align:left; }
        .controls { margin:12px auto; width:90%; max-width:980px; }
        .controls .row { display:flex; align-items:center; gap:10px; margin-bottom:8px; flex-wrap:nowrap; }
        .controls .row1 { align-items:center; }
        .form-control { padding:8px 10px; border: 1px solid #d8cfc0; border-radius:6px; min-width:120px; }
        .app-btn { background:#0366d6; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; height:38px; min-width:110px; }
        .app-btn:hover { opacity:0.95; }
        .note { margin-left:6px; color:#555; font-size:13px; }
        #csvFileInput { display:none; }

        /* Info icon and popup */
        .info-icon { display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:50%; background:#0366d6; color:#fff; font-size:12px; cursor:pointer; margin-left:6px; }
        .info-popup { display:none; position:fixed; left:50%; top:20%; transform:translateX(-50%); background:#fff; border:1px solid #ddd; padding:12px; max-width:380px; box-shadow:0 6px 24px rgba(0,0,0,0.12); border-radius:8px; z-index:1200; }
        .info-popup .close { float:right; cursor:pointer; color:#666; margin-left:8px; }

        @media (max-width: 860px) {
            .main-row { grid-template-columns: 1fr; }
            .rashi-chart { grid-template-columns: repeat(4, 70px); grid-template-rows: repeat(4,70px); }
            .controls { width:95%; }
            .controls .row { gap:8px; }
            .form-control { min-width: 110px; flex: 1 1 140px; }
            .app-btn { flex: 0 0 120px; }
        }

        .row.header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            h1, h2, h3 { font-size: 18px !important; }
            .row.header-controls { flex-direction: column; align-items: stretch; }
            .main-row { grid-template-columns: 1fr; }
            .controls-wrapper { width: 100%; padding: 0 6px; box-sizing: border-box; }
            .analysis { width: 100%; margin: 20px auto; padding: 16px; }
            .author-footer { padding: 15px; font-size: 13px; }
            .rashi-chart { grid-template-columns: repeat(4, 60px); grid-template-rows: repeat(4,60px); }
        }

        @media (max-width: 420px) {
            .controls .row { flex-direction:column; align-items:stretch; }
            .app-btn { width:100%; }
        }

    </style>  
</head>
<body>

<div style="text-align:center; margin:0 0 4px 0; width:100%;">
    <img src="logo.gif" alt="Logo" style="display:block; margin:0 auto 4px auto; max-width:120px; height:auto;" />
    <h2 style="font-size:30px; margin:0;">Double Transit WebAppp</h2>
</div>
<div style="font-size:13px; text-align:center; color:#333; margin-bottom:12px;">Natal &amp; Transit Marriage Yoga Analyzer</div>

<div class="controls-wrapper">
    <div class="controls">
        <div class="row row1 header-controls">
            <label for="natalInput"><strong>Natal Planets</strong></label>
            <span id="infoNatal" class="info-icon" title="Info">i</span>
            <input id="natalInput" class="form-control" type="text" placeholder="2,10,8,6,10,7,10,6,2,8" />
            <button id="loadNatalBtn" class="app-btn">Load Natal</button>

            <label for="transitDate" style="margin-left:12px;"><strong>Transit Date:</strong></label>
            <input id="transitDate" class="form-control" type="date" />
            <button id="loadTransitBtn" class="app-btn">Load Transit</button>
            <div id="natalMessage" class="note"></div>
        </div>

        <div class="row row2">
            <label for="dobInput"><strong>DOB:</strong></label>
            <input id="dobInput" class="form-control" type="date" />

            <label for="moonDegInput"><strong>Moon long:</strong></label>
            <input id="moonDegInput" class="form-control" type="text" placeholder="e.g. 12.34" />

            <button id="calcDashaBtn" class="app-btn">Calculate Dasha</button>
            <div id="dataMessage" class="note"></div>
        </div>
        <div id="dashaMessage" class="note" style="margin-top:6px;"></div>
    </div>

    <div id="infoPopup" class="info-popup" role="dialog" aria-hidden="true">
        <span class="close" id="infoClose">âœ•</span>
        <div><strong>How to enter Natal Planets</strong></div>
        <div style="margin-top:8px;">Enter Natal Planets in this order: <br/><code>Lg,Su,Ch,Ku,Bu,Gu,Sk,Sa,Ra,Ke</code></div>
    </div>
</div> 

<div class="main-row">
    <div class="chart-column natal-column">
        <h3>Natal Chart (with Transit)</h3>
        <div class="rashi-chart natal simple" id="natalChart">
            <div class="rashi-box b12"><span class="rashi-number">12</span><div class="planet-names" id="natal-box12"></div></div>
            <div class="rashi-box b1"><span class="rashi-number">1</span><div class="planet-names" id="natal-box1"></div></div>
            <div class="rashi-box b2"><span class="rashi-number">2</span><div class="planet-names" id="natal-box2"></div></div>
            <div class="rashi-box b3"><span class="rashi-number">3</span><div class="planet-names" id="natal-box3"></div></div>

            <div class="rashi-box b11"><span class="rashi-number">11</span><div class="planet-names" id="natal-box11"></div></div>
            <div class="chart-title">Rashi Chakra</div>
            <div class="rashi-box b4"><span class="rashi-number">4</span><div class="planet-names" id="natal-box4"></div></div>

            <div class="rashi-box b10"><span class="rashi-number">10</span><div class="planet-names" id="natal-box10"></div></div>
            <div class="rashi-box b5"><span class="rashi-number">5</span><div class="planet-names" id="natal-box5"></div></div>

            <div class="rashi-box b9"><span class="rashi-number">9</span><div class="planet-names" id="natal-box9"></div></div>
            <div class="rashi-box b8"><span class="rashi-number">8</span><div class="planet-names" id="natal-box8"></div></div>
            <div class="rashi-box b7"><span class="rashi-number">7</span><div class="planet-names" id="natal-box7"></div></div>
            <div class="rashi-box b6"><span class="rashi-number">6</span><div class="planet-names" id="natal-box6"></div></div>
        </div>
        <div id="transitTable" style="margin-top:10px;"></div>
    </div>

    <div class="right-column">
        <div class="analysis" id="analysis"></div>
    </div>
</div>

<script src="dasha.js"></script>
<script>
    // ---------- INPUT DATA ----------
    const natal = {
        Lagna: 4,
        Su: 8, Ch: 8, Ku: 5, Bu: 8, Gu: 8,
        Sk: 7, Sa: 11, Ra: 7, Ke: 1
    };

    const transit = {
        Lagna: 6,
        Su: 4, Ch: 7, Ku: 2, Bu: 5, Gu: 2,
        Sk: 5, Sa: 11, Ra: 6
    };

    // For now this simple boolean controls whether current dasha supports marriage timing
    const dashaSupportsMarriage = true;

    const signs = [
        "1 Mesha", "2 Vrishabha", "3 Mithuna", "4 Karkataka",
        "5 Simha", "6 Kanya", "7 Tula", "8 Vrischika",
        "9 Dhanu", "10 Makara", "11 Kumbha", "12 Meena"
    ];

    // ---------- RASHI CHART POPULATION ----------

    function clearChart(prefix) {
        for (let i = 1; i <= 12; i++) {
            const el = document.getElementById(`${prefix}-box${i}`);
            if (el) el.innerHTML = "";
        }
    }

    function populateChart(prefix, data) {
        clearChart(prefix);
        for (let planet in data) {
            const sign = data[planet];
            const box = document.getElementById(`${prefix}-box${sign}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = (planet === 'Lagna') ? 'Lg' : planet;
                box.appendChild(span);
            }
        }
    }

    // populate natal chart initially
    populateChart("natal", natal);
    addTransitToChart(transit);

    // ---------- TRANSIT CSV LOADING & DATE NAVIGATION ----------
    (function() {
        let dateInput = document.getElementById('transitDate');
        // replace input element with a fresh clone to ensure no old handlers remain
        const _clone = dateInput.cloneNode(true);
        dateInput.parentNode.replaceChild(_clone, dateInput);
        dateInput = _clone;

        const loadBtn = document.getElementById('loadTransitBtn');
        const fileInput = document.getElementById('csvFileInput');
        const dataMessage = document.getElementById('dataMessage');

        function pad(n){ return n<10? '0'+n: ''+n; }
        function formatDateDDMMYYYY(d){ return pad(d.getDate()) + '-' + pad(d.getMonth()+1) + '-' + d.getFullYear(); }
        function formatDateForInput(d){ return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }

        // flexible parser for various date formats we might encounter in CSV
        function parseDateFlexible(s){
            if (!s) return null;
            s = s.trim();
            s = s.replace(/\//g, '-');
            let m;
            // ISO YYYY-MM-DD (from input[type=date]) -> create local date at midnight
            if (m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/)){
                const yr = parseInt(m[1],10), mon = parseInt(m[2],10), day = parseInt(m[3],10);
                return new Date(yr, mon-1, day);
            }
            if (m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{2,4})$/)){
                let day = parseInt(m[1],10), mon = parseInt(m[2],10), yr = parseInt(m[3],10);
                if (yr < 100) yr += 2000;
                return new Date(yr, mon-1, day);
            }
            if (m = s.match(/^(\d{1,2})-([A-Za-z]+)-(\d{2,4})$/)){
                let day = parseInt(m[1],10), monStr = m[2], yr = parseInt(m[3],10);
                if (yr < 100) yr += 2000;
                const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
                const key = monStr.substring(0,3).toLowerCase();
                if (months.hasOwnProperty(key)){
                    return new Date(yr, months[key], day);
                }
            }
            const d = new Date(s);
            return isNaN(d) ? null : d;
        }

        function parseCSV(text){
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
            if (!lines.length) return { rows: [], errors: [] };

            // make header-driven parsing robust to presence/absence of D9 or different column orders
            const rawHeader = lines.shift();
            const headerCols = rawHeader.split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, ''));

            const idx = name => headerCols.indexOf(name);
            const idxPlanet = idx('planet') >= 0 ? idx('planet') : 0;
            const idxFrom = idx('fromdate') >= 0 ? idx('fromdate') : 1;
            const idxTo = idx('todate') >= 0 ? idx('todate') : 2;
            const idxDir = idx('direction') >= 0 ? idx('direction') : 3;
            const idxD1 = idx('d1') >= 0 ? idx('d1') : 4;

            const rows = [];
            const errors = [];

            lines.forEach((line, i) => {
                const parts = line.split(',').map(p => p.trim());
                const planet = parts[idxPlanet] || parts[0];
                const fromRaw = parts[idxFrom] || parts[1] || '';
                const toRaw = parts[idxTo] || parts[2] || '';
                const dir = parts[idxDir] || parts[3] || null;
                const d1raw = (parts.length > idxD1 && parts[idxD1]) ? parts[idxD1] : (parts[4] || null);

                const fromDate = parseDateFlexible(fromRaw);
                const toDate = parseDateFlexible(toRaw);

                if (!fromDate) errors.push({ line: i+2, field: 'FromDate', value: fromRaw });
                if (!toDate) errors.push({ line: i+2, field: 'ToDate', value: toRaw });

                rows.push({
                    Planet: planet,
                    FromDate: fromDate,
                    ToDate: toDate,
                    Direction: dir,
                    D1: d1raw ? parseInt(d1raw,10) : null,
                    rawLine: line
                });
            });

            return { rows, errors };
        }

        function findPlanetTransitOnDate(rows, planetName, date){
            return rows.find(r => r.Planet && r.Planet.toLowerCase() === planetName.toLowerCase() && r.FromDate && r.ToDate && date >= r.FromDate && date <= r.ToDate) || null;
        }

        function applyTransitFromRows(rows, date){
            const g = findPlanetTransitOnDate(rows, 'Guru', date);
            const s = findPlanetTransitOnDate(rows, 'Shani', date);
            let found = false;
            if (g && g.D1) { transit.Gu = g.D1; found = true; }
            if (s && s.D1) { transit.Sa = s.D1; found = true; }
            // Redraw natal chart with updated transit data
            addTransitToChart(transit);
            return { found, guruRow: g, shaniRow: s };
        }

        async function fetchCSVAndApply(date){
            try{
                const res = await fetch('Transit_Guru-Shani.csv');
                if (!res.ok) throw new Error('Fetch failed: ' + res.status);
                const txt = await res.text();
                const parsed = parseCSV(txt);
                const rows = parsed.rows || [];
                const errors = parsed.errors || [];

                if (errors && errors.length){
                    const list = errors.map(e => `<li>Line ${e.line}: invalid ${e.field} ('${e.value}')</li>`).join('');
                    dataMessage.innerHTML = `<span class="no">CSV contains malformed dates:</span><ul class="csv-errors">${list}</ul>`;
                    console.warn('CSV date errors', errors);
                }

                const resObj = applyTransitFromRows(rows, date);
                if (resObj.found){
                    analyzeMarriage();
                    displayTransitTable(date, resObj.guruRow, resObj.shaniRow);
                    if (!errors || !errors.length) {
                        dataMessage.textContent = `Loaded transit for ${formatDateDDMMYYYY(date)} from CSV.`;
                    } else {
                        dataMessage.innerHTML += `<div>Loaded transit for ${formatDateDDMMYYYY(date)} from CSV (some rows had errors).</div>`;
                    }
                } else {
                    if (!errors || !errors.length){
                        dataMessage.textContent = `No Guru/Shani rows found in CSV for ${formatDateDDMMYYYY(date)}. Using fallback transit.`;
                    } else {
                        dataMessage.innerHTML += `<div>No Guru/Shani rows usable for ${formatDateDDMMYYYY(date)}. Using fallback transit.</div>`;
                    }
                    displayTransitTable(date, null, null);
                }
            } catch (err){
                console.warn(err);
                dataMessage.textContent = 'Could not fetch CSV automatically. You can upload the CSV with the file picker.';
                displayTransitTable(date, null, null);
            }
        }

        // file input fallback
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = function(ev){
                try{
                    const parsed = parseCSV(ev.target.result);
                    const rows = parsed.rows || [];
                    const errors = parsed.errors || [];

                    if (errors.length){
                        const list = errors.map(er => `<li>Line ${er.line}: invalid ${er.field} ('${er.value}')</li>`).join('');
                        dataMessage.innerHTML = `<span class="no">CSV contains malformed dates:</span><ul class="csv-errors">${list}</ul>`;
                        console.warn('CSV date errors', errors);
                    }

                    const date = parseDateFlexible(dateInput.value) || new Date();
                    const resObj = applyTransitFromRows(rows, date);
                    if (resObj.found){
                        analyzeMarriage();
                        displayTransitTable(date, resObj.guruRow, resObj.shaniRow);
                        if (errors.length){
                            dataMessage.innerHTML += `<div>Loaded transit for ${formatDateDDMMYYYY(date)} from uploaded CSV (some rows had errors).</div>`;
                        } else {
                            dataMessage.textContent = `Loaded transit for ${formatDateDDMMYYYY(date)} from uploaded CSV.`;
                        }
                    } else {
                        dataMessage.innerHTML += `<div>No Guru/Shani rows found in uploaded CSV for ${formatDateDDMMYYYY(date)}.</div>`;
                        displayTransitTable(date, null, null);
                    }
                }catch(err){
                    console.warn(err);
                    dataMessage.textContent = 'Error parsing uploaded CSV.';
                }
            };
            reader.readAsText(f);
            });
        }

        // Load button clicked
        loadBtn.addEventListener('click', () => {
            const date = parseDateFlexible(dateInput.value);
            if (!date){ dataMessage.textContent = 'Please select a valid date.'; return; }
            fetchCSVAndApply(date);
        });

        // Simple handler: Enter triggers load.
        dateInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { loadBtn.click(); }
        });

        // Auto-fetch when date changes (supports keyboard/year navigation). Debounced to avoid excessive fetches.
        let dateInputTimer = null;
        function scheduleFetchDate(){
            const date = parseDateFlexible(dateInput.value);
            if (!date){ dataMessage.textContent = 'Please select a valid date.'; return; }
            dataMessage.textContent = 'Loading transit for ' + formatDateDDMMYYYY(date) + '...';
            if (dateInputTimer) clearTimeout(dateInputTimer);
            dateInputTimer = setTimeout(() => { fetchCSVAndApply(date); dateInputTimer = null; }, 300);
        }
        dateInput.addEventListener('change', scheduleFetchDate);
        dateInput.addEventListener('input', scheduleFetchDate);

        function displayTransitTable(date, guruRow, shaniRow){
            const el = document.getElementById('transitTable'); if (!el) return;
            function rowHtml(planetName, row){
                if (!row || !row.D1){
                    return `<tr><td>${planetName}</td><td colspan="3">No data</td></tr>`;
                }
                const dir = row.Direction || '';
                const from = row.FromDate ? formatDateDDMMYYYY(row.FromDate) : 'N/A';
                const to = row.ToDate ? formatDateDDMMYYYY(row.ToDate) : 'N/A';
                return `<tr><td>${planetName}</td><td>${dir}</td><td>${from}</td><td>${to}</td></tr>`;
            }
            let html = `<h4>Transit Table (Guru & Shani)</h4>`;
            html += `<div class="table-wrapper">`;
            html += `<table class="status-table" style="margin-top:8px; width:100%;"><thead><tr><th>Planet</th><th>Dir</th><th>From</th><th>To</th></tr></thead><tbody>`;
            html += rowHtml('Shani', shaniRow);
            html += rowHtml('Guru', guruRow);
            html += `</tbody></table></div>`;

            el.innerHTML = html;
        }

        // NATAL INPUT HANDLING
        const natalInput = document.getElementById('natalInput');
        const loadNatalBtn = document.getElementById('loadNatalBtn');
        const natalMessage = document.getElementById('natalMessage');

        const natalKeys = ['Lagna','Su','Ch','Ku','Bu','Gu','Sk','Sa','Ra','Ke'];

        function applyNatalArray(arr){
            // arr is array of numbers length 10
            natalKeys.forEach((k,i) => { natal[k] = arr[i]; });
            populateChart('natal', natal);
            addTransitToChart(transit);
            analyzeMarriage();
        }

        function parseNatalValue(s){
            if (!s) return { ok: false, error: 'Empty input' };
            const parts = s.split(/[\s,]+/).map(p => p.trim()).filter(p => p.length);
            if (parts.length !== 10) return { ok: false, error: 'Expected exactly 10 numbers (found ' + parts.length + ')' };
            const nums = parts.map(p => parseInt(p,10));
            for (let i=0;i<nums.length;i++){
                const n = nums[i];
                if (!Number.isInteger(n) || n < 1 || n > 12) return { ok: false, error: 'Value at position ' + (i+1) + ' is invalid: ' + parts[i] };
            }
            return { ok: true, nums };
        }

        loadNatalBtn.addEventListener('click', () => {
            const parsed = parseNatalValue(natalInput.value);
            if (!parsed.ok){ natalMessage.innerHTML = `<span class="no">${parsed.error}</span>`; return; }
            applyNatalArray(parsed.nums);
            natalMessage.innerHTML = `<span class="yes">Natal chart updated</span>`;
        });
        natalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadNatalBtn.click(); });

        // set default date to today (ISO format for date input)
        dateInput.value = formatDateForInput(new Date());
        // set default DOB to 02-12-1994 (ISO yyyy-mm-dd)
        const dobInput = document.getElementById('dobInput'); if (dobInput) dobInput.value = formatDateForInput(new Date(1994,11,2));
        // set default Moon Longitude
        const moonDeg = document.getElementById('moonDegInput'); if (moonDeg) moonDeg.value = '11.82';
        // set default natal input from current natal object
        natalInput.value = `${natal.Lagna},${natal.Su},${natal.Ch},${natal.Ku},${natal.Bu},${natal.Gu},${natal.Sk},${natal.Sa},${natal.Ra},${natal.Ke}`;

        // try auto-fetch for today's date
        fetchCSVAndApply(new Date());
    })();

    // Calculate button hookup: re-run analysis which will include dasha table if inputs provided
    document.getElementById('calcDashaBtn').addEventListener('click', () => {
        analyzeMarriage();
        const msg = document.getElementById('dashaMessage'); if (msg) msg.textContent = 'Dasha calculated (see Dasha table below).';
    });

    // Info popup handlers for Natal Planets
    (function(){
        const info = document.getElementById('infoNatal');
        const popup = document.getElementById('infoPopup');
        const close = document.getElementById('infoClose');
        if (info && popup){
            info.addEventListener('click', () => { popup.style.display = 'block'; popup.setAttribute('aria-hidden','false'); });
            close.addEventListener('click', () => { popup.style.display = 'none'; popup.setAttribute('aria-hidden','true'); });
            window.addEventListener('click', (e) => { if (e.target === popup) { popup.style.display='none'; popup.setAttribute('aria-hidden','true'); } });
        }
    })();

    // ---------- ADD TRANSIT PLANETS TO NATAL CHART ----------

    /**
     * addTransitToChart(transitData)
     * Adds transit planets (Tg, Ts) to the existing natal chart boxes
     * 
     * @param {object} transitData - Object with transit positions: {Gu: 2, Sa: 11, ...}
     */
    function addTransitToChart(transitData) {
        // Clear any previous transit additions by resetting chart
        populateChart('natal', natal);
        
        // Add transit planets to chart
        if (transitData.Gu && transitData.Gu >= 1 && transitData.Gu <= 12) {
            const box = document.getElementById(`natal-box${transitData.Gu}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = 'Tg';
                box.appendChild(span);
            }
        }
        
        if (transitData.Sa && transitData.Sa >= 1 && transitData.Sa <= 12) {
            const box = document.getElementById(`natal-box${transitData.Sa}`);
            if (box) {
                const span = document.createElement("span");
                span.textContent = 'Ts';
                box.appendChild(span);
            }
        }
    }

    // ---------- TRANSIT ACTIVATION FOR MARRIAGE ----------

    // helper: shift sign by steps
    function addSign(sign, step) { return ((sign - 1 + step) % 12) + 1; }

    // aspect targets for Jupiter (Guru) and Saturn (Shani)
    function aspectTargets(planetCode, sign) {
        if (!sign) return [];
        if (planetCode === 'Gu') return [addSign(sign,4), addSign(sign,6), addSign(sign,8)]; // 5th,7th,9th
        if (planetCode === 'Sa') return [addSign(sign,2), addSign(sign,6), addSign(sign,9)]; // 3rd,7th,10th
        return [];
    }

    // reusable checks
    function isPosited(transitSign, targetSign){ return !!(transitSign && targetSign && transitSign === targetSign); }
    function isConjunct(transitSign, natalSign){ return isPosited(transitSign, natalSign); }
    function isAspecting(planetCode, transitSign, targetSign){
        if (!transitSign || !targetSign) return false;
        const a = aspectTargets(planetCode, transitSign);
        return a.includes(targetSign);
    }

    // build and return the Transit Activation table HTML (does not mutate DOM)
    function renderTransitActivationHtml(){
        const guruSign = transit.Gu;
        const shaniSign = transit.Sa;

        const seventhHouse = addSign(natal.Lagna, 6);
        const seventhLord = getLord(seventhHouse);
        const seventhLordSign = natal[seventhLord];
        const lagna = natal.Lagna;
        const lagnaLord = getLord(lagna);
        const lagnaLordSign = natal[lagnaLord];
        const janmaRashi = natal.Ch;

        const rows = [
            { label: 'Posited in 7th House', guru: isPosited(guruSign, seventhHouse), shani: isPosited(shaniSign, seventhHouse) },
            { label: 'Aspecting 7th House', guru: isAspecting('Gu', guruSign, seventhHouse), shani: isAspecting('Sa', shaniSign, seventhHouse) },
            { label: 'Aspecting 7th Lord', guru: isAspecting('Gu', guruSign, seventhLordSign), shani: isAspecting('Sa', shaniSign, seventhLordSign) },
            { label: 'Conjunction with 7th Lord', guru: isConjunct(guruSign, seventhLordSign), shani: isConjunct(shaniSign, seventhLordSign) },
            { label: 'Aspecting Lagna', guru: isAspecting('Gu', guruSign, lagna), shani: isAspecting('Sa', shaniSign, lagna) },
            { label: 'Posited in Lagna', guru: isPosited(guruSign, lagna), shani: isPosited(shaniSign, lagna) },
            { label: 'Aspecting Janma Rashi', guru: isAspecting('Gu', guruSign, janmaRashi), shani: isAspecting('Sa', shaniSign, janmaRashi) },
            { label: 'Posited in Janma Rashi', guru: isPosited(guruSign, janmaRashi), shani: isPosited(shaniSign, janmaRashi) },
            { label: 'Conjoined with Lagna Lord', guru: isConjunct(guruSign, lagnaLordSign), shani: isConjunct(shaniSign, lagnaLordSign) },
            { label: 'Aspecting Lagna Lord', guru: isAspecting('Gu', guruSign, lagnaLordSign), shani: isAspecting('Sa', shaniSign, lagnaLordSign) },
            { label: 'Aspecting Chandra', guru: isAspecting('Gu', guruSign, janmaRashi), shani: isAspecting('Sa', shaniSign, janmaRashi) }
        ];

        let html = `<h3>Transit Activation for Marriage</h3>`;
        html += `<div class="table-wrapper"><table class="status-table"><thead><tr><th>Parameter</th><th>Guru</th><th>Shani</th></tr></thead><tbody>`;
        rows.forEach(r => {
            html += `<tr><td>${r.label}</td><td>${r.guru ? '<span class="yes">Yes</span>' : ''}</td><td>${r.shani ? '<span class="yes">Yes</span>' : ''}</td></tr>`;
        });
        html += `</tbody></table></div>`;

        // Append Dasha table if DOB and Moon degrees available
        try {
            const dobVal = document.getElementById('dobInput') ? document.getElementById('dobInput').value : null;
            const moonDegVal = document.getElementById('moonDegInput') ? document.getElementById('moonDegInput').value : null;
            const moonRashi = natal && natal.Ch ? natal.Ch : null; // moon rashi from natal data
            if (dobVal && moonDegVal !== null && moonRashi) {
                const res = Dasha.calculateVimshottariDasha(dobVal, moonRashi, parseFloat(moonDegVal));
                if (!res.error && res.rows && res.rows.length) {
                    // Group pratyantar rows by Mahadasha -> Antardasha
                    const groups = {};
                    const order = [];
                    res.rows.forEach(r => {
                        const m = r.maha;
                        const a = r.antar;
                        if (!groups[m]) {
                            groups[m] = { antars: {}, orderAntar: [], start: r.from, end: r.to };
                            order.push(m);
                        }
                        if (!groups[m].antars[a]) {
                            groups[m].antars[a] = { rows: [], start: r.from, end: r.to };
                            groups[m].orderAntar.push(a);
                        }
                        groups[m].antars[a].rows.push(r);
                        if (r.from < groups[m].antars[a].start) groups[m].antars[a].start = r.from;
                        if (r.to > groups[m].antars[a].end) groups[m].antars[a].end = r.to;
                        if (r.from < groups[m].start) groups[m].start = r.from;
                        if (r.to > groups[m].end) groups[m].end = r.to;
                    });

                    // reference date: Transit Date if present else today
                    const refDateStr = (document.getElementById('transitDate') && document.getElementById('transitDate').value) || null;
                    let refDate = refDateStr ? new Date(refDateStr) : new Date();
                    if (isNaN(refDate)) refDate = new Date();

                    let currentMahaIdx = order.findIndex(m => refDate >= groups[m].start && refDate <= groups[m].end);
                    if (currentMahaIdx === -1) {
                        // try finding next upcoming mahadasha starting after refDate
                        currentMahaIdx = order.findIndex(m => groups[m].start > refDate);
                        if (currentMahaIdx === -1) currentMahaIdx = 0; // fallback
                    }
                    const mahaKey = order[currentMahaIdx];
                    const antarOrder = groups[mahaKey].orderAntar;
                    let currentAntarIdx = antarOrder.findIndex(a => refDate >= groups[mahaKey].antars[a].start && refDate <= groups[mahaKey].antars[a].end);
                    if (currentAntarIdx === -1) {
                        currentAntarIdx = antarOrder.findIndex(a => groups[mahaKey].antars[a].start > refDate);
                        if (currentAntarIdx === -1) currentAntarIdx = 0;
                    }
                    const antarKey = antarOrder[currentAntarIdx];
                    const pratyRows = groups[mahaKey].antars[antarKey].rows;
                    let currentPratyIdx = pratyRows.findIndex(p => refDate >= p.from && refDate <= p.to);
                    if (currentPratyIdx === -1) {
                        currentPratyIdx = pratyRows.findIndex(p => p.from > refDate);
                        if (currentPratyIdx === -1) currentPratyIdx = 0;
                    }
                    // store dasha groups and current index for navigation
                    window._dashaState = { groups, order, currentMahaIdx, currentAntarIdx, currentPratyIdx };

                    html += `<div style="height:12px;"></div><h4>Dasha (Mahadasha -> Antardasha -> Pratyantara)</h4>`;
                    html += `<div class="dasha-nav" style="display:flex;align-items:center;gap:16px;margin-bottom:6px;flex-wrap:nowrap;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong style="min-width:90px;">Mahadasha</strong>
                            <button id="maha-prev" class="app-btn" style="min-width:36px;padding:6px 8px;">&lt;</button>
                            <span id="maha-indicator" style="font-weight:700">${order[currentMahaIdx]}</span>
                            <button id="maha-next" class="app-btn" style="min-width:36px;padding:6px 8px;">&gt;</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong style="min-width:90px;">Antardasha</strong>
                            <button id="antar-prev" class="app-btn" style="min-width:36px;padding:6px 8px;">&lt;</button>
                            <span id="antar-indicator" style="font-weight:700">${antarOrder[currentAntarIdx]}</span>
                            <button id="antar-next" class="app-btn" style="min-width:36px;padding:6px 8px;">&gt;</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <strong style="min-width:90px;">Pratyantara</strong>
                            <button id="praty-prev" class="app-btn" style="min-width:36px;padding:6px 8px;">&lt;</button>
                            <span id="praty-indicator" style="font-weight:700">${pratyRows[currentPratyIdx].pratyantara}</span>
                            <button id="praty-next" class="app-btn" style="min-width:36px;padding:6px 8px;">&gt;</button>
                        </div>
                    </div>`;

                    html += `<div class="table-wrapper"><table id="dasha-table" class="status-table dasha-table" style="width:100%;"><thead><tr><th>Dasha</th><th>From</th><th>To</th></tr></thead><tbody id="dasha-tbody"></tbody></table></div>`;
                }
            }
        } catch (e) { console.warn('Dasha calc failed', e); }

        console.log('Transit activation table constructed', {guruSign, shaniSign, rows});
        return html;
    }

    // Render Event Manifestation Houses (Marriage Materialisation)
    function renderEventManifestationTable(){
        const guruSign = transit.Gu;
        const shaniSign = transit.Sa;

        if (!natal || !natal.Lagna){
            // return an informational message as HTML
            return `<p class="no">No natal data to evaluate event manifestation houses.</p>`;
        }

        const secondHouse = addSign(natal.Lagna, 1);
        const eleventhHouse = addSign(natal.Lagna, 10);
        const secondLord = getLord(secondHouse);
        const eleventhLord = getLord(eleventhHouse);

        const rows = [
            { label: 'Posited in 2nd House', guru: isPosited(guruSign, secondHouse), shani: isPosited(shaniSign, secondHouse) },
            { label: 'Aspecting 2nd House', guru: isAspecting('Gu', guruSign, secondHouse), shani: isAspecting('Sa', shaniSign, secondHouse) },
            { label: 'Aspecting 2nd Lord', guru: isAspecting('Gu', guruSign, natal[secondLord]), shani: isAspecting('Sa', shaniSign, natal[secondLord]) },
            { label: 'Conjunction with 2nd Lord', guru: isConjunct(guruSign, natal[secondLord]), shani: isConjunct(shaniSign, natal[secondLord]) },

            { label: 'Posited in 11th House', guru: isPosited(guruSign, eleventhHouse), shani: isPosited(shaniSign, eleventhHouse) },
            { label: 'Aspecting 11th House', guru: isAspecting('Gu', guruSign, eleventhHouse), shani: isAspecting('Sa', shaniSign, eleventhHouse) },
            { label: 'Aspecting 11th Lord', guru: isAspecting('Gu', guruSign, natal[eleventhLord]), shani: isAspecting('Sa', shaniSign, natal[eleventhLord]) },
            { label: 'Conjunction with 11th Lord', guru: isConjunct(guruSign, natal[eleventhLord]), shani: isConjunct(shaniSign, natal[eleventhLord]) }
        ];

        // Event manifestation table removed per user request
        return '';
    }

    // main analyzeMarriage entry now renders both tables stacked (one below the other)
    function analyzeMarriage(){
        const left = renderTransitActivationHtml();
        const right = renderEventManifestationTable();
        document.getElementById('analysis').innerHTML = left + '<div style="height:12px;"></div>' + right;
        // attach dasha navigation handlers if dasha state exists
        attachDashaNavHandlers();
    }

    function attachDashaNavHandlers(){
        try {
            const state = window._dashaState;
            if (!state || !state.order || !state.groups) return;
            const mahaPrev = document.getElementById('maha-prev');
            const mahaNext = document.getElementById('maha-next');
            const mahaIndicator = document.getElementById('maha-indicator');
            const antarPrev = document.getElementById('antar-prev');
            const antarNext = document.getElementById('antar-next');
            const antarIndicator = document.getElementById('antar-indicator');
            const pratyPrev = document.getElementById('praty-prev');
            const pratyNext = document.getElementById('praty-next');
            const pratyIndicator = document.getElementById('praty-indicator');
            const tbody = document.getElementById('dasha-tbody');
            if (!mahaIndicator || !antarIndicator || !pratyIndicator || !tbody) return;

            function currentMahaKey(){ return state.order[state.currentMahaIdx]; }
            function currentAntarOrder(){
                const mahaKey = currentMahaKey();
                return state.groups[mahaKey].orderAntar;
            }
            function currentAntarKey(){
                const antarOrder = currentAntarOrder();
                return antarOrder[state.currentAntarIdx];
            }
            function currentPratyRows(){
                const mahaKey = currentMahaKey();
                const antarKey = currentAntarKey();
                return state.groups[mahaKey].antars[antarKey].rows;
            }

            function renderState(){
                const mahaKey = currentMahaKey();
                const antarOrder = currentAntarOrder();
                const antarKey = currentAntarKey();
                const pratyRows = currentPratyRows();
                const praty = pratyRows[state.currentPratyIdx];
                mahaIndicator.textContent = mahaKey || '';
                antarIndicator.textContent = antarKey || '';
                pratyIndicator.textContent = praty ? praty.pratyantara : '';

                tbody.innerHTML = '';
                pratyRows.forEach((r, idx) => {
                    const label = `${r.maha}-${r.antar}-${r.pratyantara}`;
                    const rowClass = (idx === state.currentPratyIdx) ? 'dasha-current' : '';
                    const tr = `<tr class="${rowClass}"><td>${label}</td><td>${Dasha.formatDate(r.from)}</td><td>${Dasha.formatDate(r.to)}</td></tr>`;
                    tbody.innerHTML += tr;
                });
            }

            function setMahaIdx(nextIdx){
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= state.order.length) nextIdx = state.order.length - 1;
                state.currentMahaIdx = nextIdx;
                state.currentAntarIdx = 0;
                state.currentPratyIdx = 0;
                renderState();
            }
            function setAntarIdx(nextIdx){
                const antarOrder = currentAntarOrder();
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= antarOrder.length) nextIdx = antarOrder.length - 1;
                state.currentAntarIdx = nextIdx;
                state.currentPratyIdx = 0;
                renderState();
            }
            function setPratyIdx(nextIdx){
                const pratyRows = currentPratyRows();
                if (nextIdx < 0) nextIdx = 0;
                if (nextIdx >= pratyRows.length) nextIdx = pratyRows.length - 1;
                state.currentPratyIdx = nextIdx;
                renderState();
            }

            if (mahaPrev) mahaPrev.addEventListener('click', () => { setMahaIdx(state.currentMahaIdx - 1); });
            if (mahaNext) mahaNext.addEventListener('click', () => { setMahaIdx(state.currentMahaIdx + 1); });
            if (antarPrev) antarPrev.addEventListener('click', () => { setAntarIdx(state.currentAntarIdx - 1); });
            if (antarNext) antarNext.addEventListener('click', () => { setAntarIdx(state.currentAntarIdx + 1); });
            if (pratyPrev) pratyPrev.addEventListener('click', () => { setPratyIdx(state.currentPratyIdx - 1); });
            if (pratyNext) pratyNext.addEventListener('click', () => { setPratyIdx(state.currentPratyIdx + 1); });

            renderState();
        } catch (e){ console.warn('attachDashaNavHandlers failed', e); }
    }

    function getLord(sign) {
        const lords = {
            1: "Ku", 2: "Sk", 3: "Bu", 4: "Ch",
            5: "Su", 6: "Bu", 7: "Sk", 8: "Ku",
            9: "Gu", 10: "Sa", 11: "Sa", 12: "Gu"
        };
        return lords[sign];
    }

    analyzeMarriage();
</script>

<footer class="author-footer">
    <div class="title">About the Author</div>
    <div>
        This application was created by Srikanth Dharmavaram as a teaching aid for students of Vedic Astrology.
        It is built with the aim of simplifying complex concepts like Dasha timing and Double Transit activation for practical learning and research.
    </div>
    <div class="email"><a href="https://vaiswanara.com" target="_blank" rel="noopener">https://vaiswanara.com</a></div>
</footer>

</body>
</html>
